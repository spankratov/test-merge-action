name: Sync Branches After Release

on:
  repository_dispatch:
    types: [production-deployed]

jobs:
  sync-branches:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.PROTECTED_BRANCHES_TOKEN }}

      - name: Configure Git Bot
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Merge Release Candidate to Release Branch
        id: merge-release
        run: |
          # Extract version from the payload sent by Concourse
          VERSION="${{ github.event.client_payload.version }}"
          RC_BRANCH="releases/v$VERSION"

          echo "Detected version: $VERSION"
          echo "Syncing $RC_BRANCH -> release"

          git checkout release
          
          git merge "origin/$RC_BRANCH" --no-edit
          
          git push origin release
          
      - name: Create PR to Main
        env:
          GH_TOKEN: ${{ secrets.PROTECTED_BRANCHES_TOKEN }}
        run: |
          pr_url=$(gh pr create \
            --base main \
            --head release \
            --title "chore: Sync release to main (v${{ github.event.client_payload.version }})" \
            --body "Automated PR to sync changes from release branch to main after production deployment.")
      
          echo "PR Created: $pr_url"
      
          gh pr merge "$pr_url" --merge
