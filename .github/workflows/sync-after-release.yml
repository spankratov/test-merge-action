name: Sync Branches After Release

on:
  repository_dispatch:
    types: [production-deployed]

jobs:
  sync-branches:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          # If your branches are protected, you MUST use a PAT here, not the default GITHUB_TOKEN
          token: ${{ secrets.PROTECTED_BRANCHES_TOKEN }}

      - name: Configure Git Bot
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Merge Release Candidate to Release Branch
        id: merge-release
        run: |
          # Extract version from the payload sent by Concourse
          VERSION="${{ github.event.client_payload.version }}"
          RC_BRANCH="releases/v$VERSION"

          echo "Detected version: $VERSION"
          echo "Syncing $RC_BRANCH -> release"

          # Checkout 'release' branch
          git checkout release
          
          # Merge the specific release version branch
          git merge "origin/$RC_BRANCH" --no-edit
          
          # Push to remote
          git push origin release
          
          # Step 2: Create and Auto-Merge PR from Release to Main
          - name: Create PR to Main
            env:
              GH_TOKEN: ${{ secrets.PROTECTED_BRANCHES_TOKEN }} # Use PAT to bypass "Actions cannot trigger other workflows" limits
            run: |
              # 1. Create the Pull Request
              # --base: where we want to merge INTO (main)
              # --head: where changes come FROM (release)
              pr_url=$(gh pr create \
                --base main \
                --head release \
                --title "chore: Sync release to main (v${{ github.event.client_payload.version }})" \
                --body "Automated PR to sync changes from release branch to main after production deployment.")
          
              echo "PR Created: $pr_url"
          
              # 2. Enable Auto-Merge
              # This tells GitHub: "As soon as all status checks pass, merge this."
              gh pr merge "$pr_url" --auto --merge
