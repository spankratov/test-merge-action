name: Sync Branches After Release

on:
  repository_dispatch:
    types: [production-deployed]

jobs:
  sync-branches:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git Bot
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Merge Release Candidate to Release Branch
        id: merge-release
        run: |
          # Extract version from the payload sent by Concourse
          VERSION="${{ github.event.client_payload.version }}"
          RC_BRANCH="releases/v$VERSION"

          echo "Detected version: $VERSION"
          echo "Syncing $RC_BRANCH -> release"

          git checkout release
          
          git merge "origin/$RC_BRANCH" --no-edit
          
          git push origin release
          
      - name: Merge Release Branch to Main
        env:
          GH_TOKEN: ${{ secrets.PROTECTED_BRANCHES_TOKEN }}
        run: |
          git checkout main
          
          git merge origin/release --no-edit
          
          git push origin main
